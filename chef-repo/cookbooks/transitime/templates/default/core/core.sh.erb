#!/bin/bash

cd /var/lib/oba/transitime/core
java \
  -classpath logback-core-1.1.2.jar:logback-classic-1.1.2.jar:slf4j-api-1.7.2.jar \
  -Xmx10g \
  -Dtransitime.core.agencyId=<%= node[:transitime][:agency] %> \
  -Dtransitime.db.dbName=<%= node[:transitime][:dbname] %> \
  -Dtransitime.db.encryptionPassword='<%= node[:transitime][:encryptionPassword] %>' \
  -Dtransitime.db.batchSize=4000 \
  -Dtransitime.modules.optionalModulesList="org.transitime.core.predAccuracy.PredictionAccuracyModule;org.transitime.custom.aws.AvlSqsClientModule;org.transitime.monitoring.MonitoringModule" \
  -Dtransitime.avl.feedTimeoutInMSecs=30000 \
  -Dtransitime.core.maxPredictionTimeForDbSecs=3600 \
  -Dtransitime.core.exclusiveBlockAssignments=true \
  -Dtransitime.core.matchHistoryMaxSize=40 \
  -Dtransitime.avl.queueSize=100000 \
  -Dtransitime.avl.shouldUseSqs=true \
  -Dtransitime.avl.sqsUrl='<%= node[:transitime][:sqsUrl] %>' \
  -Dtransitime.avl.messageLogFrequency=1000 \
  -Dtransitime.avl.sqsKey='<%= node[:transitime][:sqsKey] %>' \
  -Dtransitime.avl.sqsSecret='<%= node[:transitime][:sqsSecret] %>' \
  -Dtransitime.avl.snsKey='<%= node[:transitime][:snsKey] %>' \
  -Dtransitime.avl.snsSecret='<%= node[:transitime][:snsSecret] %>' \
  -Dtransitime.avl.snsArn='<%= node[:transitime][:snsArn] %>' \
  -Dtransitime.avl.jmsNumThreads=20 \
  -Dtransitime.avl.jmsQueueSize=10000 \
  -Dtransitime.blockLoading.agressive=true \
  -Dtransitime.avl.numThreads=20 \
  -Dtransitime.avl.maxSpeed=45 \
  -Dtransitime.avl.allowableNoAvl=10 \
  -Dtransitime.environmentName=<%= node["oba"]["env"] %> \
  -Dtransitime.cloudwatch.awsAccessKey='<%= node["aws"]["cloudwatch_publish_key"] %>' \
  -Dtransitime.cloudwatch.awsSecretKey='<%= node["aws"]["cloudwatch_publish_secret"] %>' \
  -Dtransitime.cloudwatch.awsEndpoint='<%= node["aws"]["cloudwatch_endpoint"] %>' \
  -Dtransitime.predAccuracy.externalPredictionApiUrl="http://webservices.nextbus.com/service/xmlFeed?" \
  -Dtransitime.predAccuracy.nextBusAgencyIdForApi=wmata \
  -Dtransitime.hibernate.configFile=/var/lib/oba/transitime/core/mysql_hibernate.cfg.xml \
  -Dlogback.configuration=/var/lib/oba/transitime/core/logback.xml \
  -jar \
  core.jar >/dev/null 2>&1
